language: python

sudo: required
os: linux
dist: trusty
group: edge

services:
    - docker
python:
    - "3.6"

env:
    matrix:
        - TESTENV=docs
        - TESTENV=code
        - TESTENV=pylint
        - TESTENV=build

before_install:
  - wget http://hgdownload.soe.ucsc.edu/admin/exe/linux.x86_64/bigWigToWig
  - chmod +x ./bigWigToWig
  - chmod +x ./scripts/travis/docs_harness.sh
  - chmod +x ./scripts/travis/pylint_harness.sh
# command to install dependencies
install:
    - pip install -r requirements.txt
    - if [[ "$TESTENV" == "docs" ]]; then pip install sphinx;fi
    - if [[ "$TESTENV" == "pylint" ]]; then pip install pylint;fi
    - if [[ "$TESTENV" == "build" ]]; then pip install pyinstaller;fi

# command to run tests
script:
    - if [[ "$TESTENV" == "code" ]]; then pytest tests; fi
    - if [[ "$TESTENV" == "docs" ]]; then ./scripts/travis/docs_harness.sh; fi
    - if [[ "$TESTENV" == "pylint" ]]; then ./scripts/travis/pylint_harness.sh; fi
    - if [[ "$TESTENV" == "build" ]]; then pyinstaller --onefile ./scripts/GC_analysis.py; docker build -t tonyyzy/gc_analysis .; fi

deploy:
  - provider: releases
    skip-cleanup: true
    file: ./dist/GC_analysis
    api_key: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
    keep-history: true
    on:
      tags: true

  - provider: script
    script: bash ./scripts/travis/docker_push.sh
    on:
      tags: true
